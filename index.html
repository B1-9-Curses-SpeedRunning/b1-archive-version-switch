<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘ç¥è¯æ‚Ÿç©ºå­˜æ¡£ç‰ˆæœ¬åˆ‡æ¢å·¥å…·</title>
    <!-- ä½¿ç”¨æ‚¨æä¾›çš„Vue.jsé“¾æ¥ -->
    <script src="https://bylizn.oss-cn-hangzhou.aliyuncs.com/vue.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-top: 20px;
        }

        header {
            background: linear-gradient(to right, #2575fc, #6a11cb);
            color: white;
            padding: 25px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #2575fc;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed #6a11cb;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s;
            background-color: #f8f9ff;
            cursor: pointer;
            margin-bottom: 25px;
        }

        .upload-area:hover,
        .upload-area.dragover {
            background-color: #eef2ff;
            border-color: #2575fc;
        }

        .upload-icon {
            font-size: 60px;
            color: #6a11cb;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #666;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background-color: #f1f5ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
        }

        .info-label {
            font-weight: 600;
            width: 120px;
            color: #555;
        }

        .version-info {
            background-color: #f1f5ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .version-status {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .version-icon {
            font-size: 40px;
            margin-right: 15px;
        }

        .version-details h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: #2575fc;
        }

        .version-signature {
            font-family: 'Courier New', monospace;
            background-color: #1a2332;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: inline-block;
        }

        .version-control {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8f9ff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .version-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
        }

        .version-select:focus {
            border-color: #6a11cb;
            outline: none;
        }

        .download-btn {
            width: 100%;
            padding: 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .download-btn:hover {
            background-color: #218838;
        }

        .download-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            flex-grow: 1;
        }

        .upload-btn {
            background-color: #6a11cb;
            color: white;
        }

        .upload-btn:hover {
            background-color: #5a0cb3;
        }

        .reset-btn {
            background-color: #ff6b6b;
            color: white;
        }

        .reset-btn:hover {
            background-color: #ff5252;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: #6a11cb;
            width: 0%;
            transition: width 0.3s;
        }

        .signature-info {
            margin-top: 25px;
            background-color: #f8f9ff;
            border-radius: 10px;
            padding: 15px;
        }

        .signature-info h4 {
            color: #2575fc;
            margin-bottom: 10px;
        }

        .signature-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .signature-item {
            background-color: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #6a11cb;
        }

        .signature-item.current {
            background-color: #e7f5ff;
            border-left-color: #2575fc;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: white;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 95%;
            }

            h1 {
                font-size: 1.8rem;
            }

            .signature-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div id="app" class="container">
        <header>
            <h1>é»‘ç¥è¯æ‚Ÿç©ºå­˜æ¡£ç‰ˆæœ¬åˆ‡æ¢å·¥å…·</h1>
            <p class="subtitle">è¯†åˆ«å­˜æ¡£ç‰ˆæœ¬ç‰¹å¾å€¼ï¼Œå¯éšæ„åˆ‡æ¢ç‰ˆæœ¬ã€‚</p>
        </header>

        <div class="main-content">
            <div class="upload-section">
                <h2 class="section-title">æ–‡ä»¶ä¸Šä¼ </h2>

                <div class="upload-area" :class="{ 'dragover': isDragOver }" @click="triggerFileInput"
                    @dragover.prevent="handleDragOver" @dragleave="handleDragLeave" @drop.prevent="handleDrop">
                    <div class="upload-icon">ğŸ“</div>
                    <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„</p>
                    <p class="upload-hint">æ”¯æŒä»»ä½•ç±»å‹çš„æ–‡ä»¶ï¼ˆæœ€å¤§10MBï¼‰</p>
                    <input type="file" id="fileInput" class="file-input" @change="handleFileSelect" ref="fileInput">
                </div>

                <div class="file-info" v-if="fileInfo.name">
                    <div class="info-row">
                        <div class="info-label">æ–‡ä»¶å:</div>
                        <div>{{ fileInfo.name }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">æ–‡ä»¶ç±»å‹:</div>
                        <div>{{ fileInfo.type || 'æœªçŸ¥' }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">æ–‡ä»¶å¤§å°:</div>
                        <div>{{ formatFileSize(fileInfo.size) }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">æœ€åä¿®æ”¹:</div>
                        <div>{{ formatDate(fileInfo.lastModified) }}</div>
                    </div>
                </div>
                <div class="file-info" v-else>
                    <p style="text-align: center; color: #666;">æ–‡ä»¶ä¿¡æ¯å°†åœ¨æ­¤æ˜¾ç¤º</p>
                </div>

                <div class="progress-container" :class="{ 'show': isReading }">
                    <div>è¯»å–ä¸­: <span>{{ progress }}%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" :style="{ width: progress + '%' }"></div>
                    </div>
                </div>

                <div class="controls">
                    <button class="upload-btn" @click="triggerFileInput">é€‰æ‹©æ–‡ä»¶</button>
                    <button class="reset-btn" @click="resetAll">é‡ç½®</button>
                </div>
            </div>

            <div class="version-info" v-if="currentVersion">
                <div class="version-status">
                    <div class="version-icon">ğŸ”</div>
                    <div class="version-details">
                        <h3>æ£€æµ‹åˆ°æ–‡ä»¶ç‰ˆæœ¬: {{ currentVersion.name }}</h3>
                        <p>ç‰¹å¾å€¼ä½ç½®: {{ formatHex(currentVersion.position) }}</p>
                        <div class="version-signature">
                            {{ currentVersion.signatureHex }}
                        </div>
                    </div>
                </div>

                <div class="signature-info">
                    <h4>ç‰ˆæœ¬ç‰¹å¾å€¼å¯¹åº”è¡¨:</h4>
                    <div class="signature-list">
                        <div v-for="version in versions" :key="version.id" class="signature-item"
                            :class="{ 'current': currentVersion.id === version.id }">
                            <div><strong>{{ version.name }}</strong></div>
                            <div style="font-family: 'Courier New', monospace; font-size: 0.9rem;">
                                {{ version.signature }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="version-control" v-if="currentVersion">
                <h2 class="section-title">ç‰ˆæœ¬åˆ‡æ¢ä¸ä¸‹è½½</h2>

                <div class="control-group">
                    <label class="control-label">é€‰æ‹©ç›®æ ‡ç‰ˆæœ¬:</label>
                    <select class="version-select" v-model="selectedVersionId">
                        <option v-for="version in versions" :key="version.id" :value="version.id">
                            {{ version.name }} (ç‰¹å¾å€¼: {{ version.signature }})
                        </option>
                    </select>
                </div>

                <button class="download-btn" @click="downloadModifiedFile"
                    :disabled="!canDownload || selectedVersionId === currentVersion.id">
                    {{ downloadButtonText }}
                </button>

                <div v-if="selectedVersionId === currentVersion.id"
                    style="color: #6c757d; margin-top: 10px; text-align: center;">
                    å½“å‰å·²é€‰æ‹©ä¸æ–‡ä»¶ç›¸åŒçš„ç‰ˆæœ¬ï¼Œæ— éœ€ä¿®æ”¹
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>é»‘ç¥è¯æ‚Ÿç©ºå­˜æ¡£ç‰ˆæœ¬åˆ‡æ¢å·¥å…· | ä½¿ç”¨Vue.jså’ŒFile APIå®ç°</p>
    </footer>

    <script>
        new Vue({
            el: '#app',
            data: {
                fileInfo: {},
                isDragOver: false,
                isReading: false,
                progress: 0,
                byteContent: null,
                currentVersion: null,
                selectedVersionId: null,
                versions: [
                    {
                        id: 'v16',
                        name: '16ç‰ˆ',
                        signature: '58 D5 93 01',
                        signatureBytes: [0x58, 0xD5, 0x93, 0x01],
                        signatureHex: '58 D5 93 01'
                    },
                    {
                        id: 'v20',
                        name: '20ç‰ˆ',
                        signature: '58 87 AC 01',
                        signatureBytes: [0x58, 0x87, 0xAC, 0x01],
                        signatureHex: '58 87 AC 01'
                    },
                    {
                        id: 'v21',
                        name: '21ç‰ˆ',
                        signature: '58 97 BA 01',
                        signatureBytes: [0x58, 0x97, 0xBA, 0x01],
                        signatureHex: '58 97 BA 01'
                    }

                ]
            },
            computed: {
                canDownload() {
                    return this.byteContent !== null && this.selectedVersionId !== null;
                },

                downloadButtonText() {
                    if (!this.currentVersion) return 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶';
                    if (this.selectedVersionId === this.currentVersion.id) return 'æ— éœ€ä¿®æ”¹ï¼Œå·²ä¸ºæ‰€é€‰ç‰ˆæœ¬';

                    const targetVersion = this.versions.find(v => v.id === this.selectedVersionId);
                    return `ä¸‹è½½ ${targetVersion.name} ç‰ˆæœ¬æ–‡ä»¶`;
                }
            },
            watch: {
                selectedVersionId(newVal) {
                    if (newVal) {
                        // æ›´æ–°æœç´¢æ¡†æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„ç‰¹å¾å€¼
                        const version = this.versions.find(v => v.id === newVal);
                        if (version) {
                            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–é€»è¾‘
                        }
                    }
                }
            },
            methods: {
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.processFile(file);
                    }
                },

                handleDragOver() {
                    this.isDragOver = true;
                },

                handleDragLeave() {
                    this.isDragOver = false;
                },

                handleDrop(event) {
                    this.isDragOver = false;
                    const file = event.dataTransfer.files[0];
                    if (file) {
                        this.processFile(file);
                    }
                },

                async processFile(file) {
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    if (file.size > maxSize) {
                        alert('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶');
                        return;
                    }

                    // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                    this.fileInfo = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        lastModified: file.lastModified
                    };

                    // å¼€å§‹è¯»å–æ–‡ä»¶
                    this.isReading = true;
                    this.progress = 0;

                    try {
                        // ä½¿ç”¨FileReaderè¯»å–æ–‡ä»¶ä¸ºArrayBuffer
                        const arrayBuffer = await this.readFileAsArrayBuffer(file);
                        this.byteContent = arrayBuffer;
                        this.progress = 100;

                        // æ£€æµ‹æ–‡ä»¶ç‰ˆæœ¬
                        this.detectFileVersion();

                        // è®¾ç½®é»˜è®¤é€‰æ‹©ä¸ºå½“å‰ç‰ˆæœ¬
                        //if (this.currentVersion) {
                        //    this.selectedVersionId = this.currentVersion.id;
                        //}

                        // å§‹ç»ˆè®¾ç½®ä¸º16ç‰ˆï¼ˆv16ï¼‰
                        this.selectedVersionId = 'v16';

                        // æ¨¡æ‹Ÿè¯»å–è¿›åº¦
                        setTimeout(() => {
                            this.isReading = false;
                        }, 500);

                    } catch (error) {
                        console.error('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™:', error);
                        alert('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
                        this.isReading = false;
                    }
                },

                readFileAsArrayBuffer(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();

                        reader.onloadstart = () => {
                            this.progress = 10;
                        };

                        reader.onprogress = (event) => {
                            if (event.lengthComputable) {
                                this.progress = Math.round((event.loaded / event.total) * 100);
                            }
                        };

                        reader.onload = (event) => {
                            resolve(event.target.result);
                        };

                        reader.onerror = () => {
                            reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                        };

                        reader.readAsArrayBuffer(file);
                    });
                },

                detectFileVersion() {
                    if (!this.byteContent) {
                        this.currentVersion = null;
                        return;
                    }

                    const bytes = new Uint8Array(this.byteContent);

                    // æœç´¢æ‰€æœ‰ç‰ˆæœ¬ç‰¹å¾å€¼
                    for (const version of this.versions) {
                        const signature = version.signatureBytes;

                        // åœ¨æ–‡ä»¶ä¸­æœç´¢ç‰¹å¾å€¼
                        for (let i = 0; i <= bytes.length - signature.length; i++) {
                            let match = true;

                            for (let j = 0; j < signature.length; j++) {
                                if (bytes[i + j] !== signature[j]) {
                                    match = false;
                                    break;
                                }
                            }

                            if (match) {
                                // æ‰¾åˆ°åŒ¹é…çš„ç‰ˆæœ¬
                                this.currentVersion = {
                                    ...version,
                                    position: i
                                };
                                return;
                            }
                        }
                    }

                    // æœªæ‰¾åˆ°åŒ¹é…çš„ç‰ˆæœ¬
                    this.currentVersion = {
                        id: 'unknown',
                        name: 'æœªçŸ¥ç‰ˆæœ¬',
                        signature: 'æœªè¯†åˆ«',
                        signatureHex: 'æœªæ‰¾åˆ°åŒ¹é…çš„ç‰¹å¾å€¼',
                        position: -1
                    };
                },

                downloadModifiedFile() {
                    if (!this.byteContent || !this.selectedVersionId) {
                        alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©ç›®æ ‡ç‰ˆæœ¬');
                        return;
                    }

                    if (this.selectedVersionId === this.currentVersion.id) {
                        alert('æ–‡ä»¶å·²ç»æ˜¯æ‰€é€‰ç‰ˆæœ¬ï¼Œæ— éœ€ä¿®æ”¹');
                        return;
                    }

                    // è·å–ç›®æ ‡ç‰ˆæœ¬ä¿¡æ¯
                    const targetVersion = this.versions.find(v => v.id === this.selectedVersionId);
                    if (!targetVersion) {
                        alert('æ— æ•ˆçš„ç‰ˆæœ¬é€‰æ‹©');
                        return;
                    }

                    // åˆ›å»ºæ–‡ä»¶çš„å‰¯æœ¬
                    const bytes = new Uint8Array(this.byteContent);

                    // å¦‚æœæ‰¾åˆ°äº†å½“å‰ç‰ˆæœ¬çš„ç‰¹å¾å€¼ä½ç½®ï¼Œåˆ™æ›¿æ¢ä¸ºç›®æ ‡ç‰ˆæœ¬çš„ç‰¹å¾å€¼
                    if (this.currentVersion.position !== -1 && this.currentVersion.position !== undefined) {
                        const position = this.currentVersion.position;
                        const targetSignature = targetVersion.signatureBytes;

                        // ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´æ›¿æ¢ç‰¹å¾å€¼
                        if (position + targetSignature.length <= bytes.length) {
                            for (let i = 0; i < targetSignature.length; i++) {
                                bytes[position + i] = targetSignature[i];
                            }

                            console.log(`å·²å°†ä½ç½® ${this.formatHex(position)} çš„ç‰¹å¾å€¼ä» ${this.currentVersion.signature} ä¿®æ”¹ä¸º ${targetVersion.signature}`);
                        } else {
                            alert('æ–‡ä»¶å¤ªå°ï¼Œæ— æ³•æ›¿æ¢ç‰¹å¾å€¼');
                            return;
                        }
                    } else {
                        alert('æœªæ‰¾åˆ°åŸå§‹ç‰¹å¾å€¼ä½ç½®ï¼Œæ— æ³•ä¿®æ”¹ç‰ˆæœ¬');
                        return;
                    }

                    // åˆ›å»ºBlobå¹¶ä¸‹è½½æ–‡ä»¶
                    const blob = new Blob([bytes], { type: this.fileInfo.type || 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');

                    // ä¿æŒåŸæ–‡ä»¶åï¼Œä½†æ·»åŠ ç‰ˆæœ¬åç¼€
                    const originalName = this.fileInfo.name;
                    const nameWithoutExt = originalName.lastIndexOf('.') > 0 ?
                        originalName.substring(0, originalName.lastIndexOf('.')) : originalName;
                    const extension = originalName.lastIndexOf('.') > 0 ?
                        originalName.substring(originalName.lastIndexOf('.')) : '';

                    const newFileName = `${nameWithoutExt}_${targetVersion.name}${extension}`;

                    a.href = url;
                    a.download = newFileName;
                    document.body.appendChild(a);
                    a.click();

                    // æ¸…ç†
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);

                    alert(`æ–‡ä»¶å·²ä¿®æ”¹ä¸º${targetVersion.name}ç‰ˆæœ¬å¹¶å¼€å§‹ä¸‹è½½`);
                },

                formatHex(value) {
                    if (value === -1) return 'æœªçŸ¥';
                    return '0x' + value.toString(16).toUpperCase().padStart(8, '0');
                },

                resetAll() {
                    this.fileInfo = {};
                    this.byteContent = null;
                    this.progress = 0;
                    this.isReading = false;
                    this.currentVersion = null;
                    this.selectedVersionId = null;
                    this.$refs.fileInput.value = '';
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                formatDate(timestamp) {
                    if (!timestamp) return 'æœªçŸ¥';
                    const date = new Date(timestamp);
                    return date.toLocaleString('zh-CN');
                }
            }
        });
    </script>
</body>

</html>